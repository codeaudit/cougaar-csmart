#!/bin/sh

# 
# <copyright>
# Copyright 2001,2002 BBNT Solutions, LLC
# under sponsorship of the Defense Advanced Research Projects Agency (DARPA).

# This program is free software; you can redistribute it and/or modify
# it under the terms of the Cougaar Open Source License as published by
# DARPA on the Cougaar Open Source Website (www.cougaar.org).

# THE COUGAAR SOFTWARE AND ANY DERIVATIVE SUPPLIED BY LICENSOR IS
# PROVIDED 'AS IS' WITHOUT WARRANTIES OF ANY KIND, WHETHER EXPRESS OR
# IMPLIED, INCLUDING (BUT NOT LIMITED TO) ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE, AND WITHOUT
# ANY WARRANTIES AS TO NON-INFRINGEMENT.  IN NO EVENT SHALL COPYRIGHT
# HOLDER BE LIABLE FOR ANY DIRECT, SPECIAL, INDIRECT OR CONSEQUENTIAL
# DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE OF DATA OR PROFITS,
# TORTIOUS CONDUCT, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
# PERFORMANCE OF THE COUGAAR SOFTWARE.
# </copyright>

# Export all recipes for import into another MySQL DB
# Note that you must get the appropriate queries
# from the recipeQueries.q file

if [ "x$3" = "x" ]; then
  echo "Usage: export-all-recipes.sh [Config DB Username] [Password] [MySQL Config DB database name] [Optional: MySQL DB host name]"
  exit
fi

# PROBLEM: Recipe names with spaces get treated as different names
if [ "x$4" = "x" ]; then
  RECIPES=`mysql -f -N -e 'SELECT DISTINCT NAME FROM lib_mod_recipe;' -u $1 -p$2 $3 < ${COUGAAR_INSTALL_PATH}/csmart/bin/all-recipes.sql`
else
  RECIPES=`mysql -f -N -e 'SELECT DISTINCT NAME FROM lib_mod_recipe;' -u $1 -p$2 -h $4 $3 < ${COUGAAR_INSTALL_PATH}/csmart/bin/all-recipes.sql`
fi

# rm recipes.txt
# echo $RECIPES > recipes.txt

\rm -f ./export-all-recipes-from-$3.sh

echo "#!/bin/sh" > export-all-recipes-from-$3.sh
echo "" >> export-all-recipes-from-$3.sh
echo "# export-all-recipes-from-$3.sh, generated by export-all-recipes.sh" >> export-all-recipes-from-$3.sh
echo "" >> export-all-recipes-from-$3.sh
echo "# WARNING: If a recipe name contains a space, this will not have worked. Edit this script by hand if necessary." >> export-all-recipes-from-$3.sh
echo "# then run it like this: './export-all-recipes-from-$3.sh'" >> export-all-recipes-from-$3.sh
echo "" >> export-all-recipes-from-$3.sh
echo "echo \"Beginning export of all recipes from DB $3....\"" >> export-all-recipes-from-$3.sh

for recipename in $RECIPES
do
  # Invoke the other script for each recipe
  echo "Preparing to export recipe named '$recipename'"
  #${COUGAAR_INSTALL_PATH}/csmart/bin/export-recipe.sh "$recipename" $1 $2 $3 $4
  echo "${COUGAAR_INSTALL_PATH}/csmart/bin/export-recipe.sh \"$recipename\" $1 $2 $3 $4" >> export-all-recipes-from-$3.sh
done

echo "echo \"Done exporting all recipes from DB $3\"" >> export-all-recipes-from-$3.sh

# Now must sed that file to change \ to / in the CIP!
# Note that all backslashed in this file must be double quoted
sed s/\\\\/\\\//g ./export-all-recipes-from-$3.sh > ./exp-fix.sh
mv ./exp-fix.sh ./export-all-recipes-from-$3.sh

echo "Script to export all recipes from $3 has been written as: export-all-recipes-from-$3.sh"
echo "WARNING: If a recipe name contains a space, this file must be edited."
echo "To run this script, do: ./export-all-recipes-from-$3.sh"
echo ""
echo "Done."
