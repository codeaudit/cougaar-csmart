#!/bin/sh

# 
# <copyright>
#  
#  Copyright 2001-2004 BBNT Solutions, LLC
#  under sponsorship of the Defense Advanced Research Projects
#  Agency (DARPA).
# 
#  You can redistribute this software and/or modify it under the
#  terms of the Cougaar Open Source License as published on the
#  Cougaar Open Source Website (www.cougaar.org).
# 
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
#  "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
#  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
#  A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
#  OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
#  LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
#  OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#  
# </copyright>

# Export all recipes for import into another MySQL DB
# Note that you must get the appropriate queries
# from the recipeQueries.q file

if [ "x$3" = "x" ]; then
  echo "Usage: export-all-recipes.sh [Config DB Username] [Password] [MySQL Config DB database name] [Optional: MySQL DB host name]"
  exit
fi

# PROBLEM: Recipe names with spaces get treated as different names
if [ "x$4" = "x" ]; then
  RECIPES=`mysql -f -N -e 'SELECT DISTINCT NAME FROM lib_mod_recipe;' -u $1 -p$2 $3 < ${COUGAAR_INSTALL_PATH}/csmart/bin/all-recipes.sql`
else
  RECIPES=`mysql -f -N -e 'SELECT DISTINCT NAME FROM lib_mod_recipe;' -u $1 -p$2 -h $4 $3 < ${COUGAAR_INSTALL_PATH}/csmart/bin/all-recipes.sql`
fi

# rm recipes.txt
# echo $RECIPES > recipes.txt

\rm -f ./export-all-recipes-from-$3.sh

echo "#!/bin/sh" > export-all-recipes-from-$3.sh
echo "" >> export-all-recipes-from-$3.sh
echo "# export-all-recipes-from-$3.sh, generated by export-all-recipes.sh" >> export-all-recipes-from-$3.sh
echo "" >> export-all-recipes-from-$3.sh
echo "# WARNING: If a recipe name contains a space, this will not have worked. Edit this script by hand if necessary." >> export-all-recipes-from-$3.sh
echo "# then run it like this: './export-all-recipes-from-$3.sh'" >> export-all-recipes-from-$3.sh
echo "" >> export-all-recipes-from-$3.sh
echo "echo \"Beginning export of all recipes from DB $3....\"" >> export-all-recipes-from-$3.sh

for recipename in $RECIPES
do
  # Invoke the other script for each recipe
  echo "Preparing to export recipe named '$recipename'"
  #${COUGAAR_INSTALL_PATH}/csmart/bin/export-recipe.sh "$recipename" $1 $2 $3 $4
  echo "${COUGAAR_INSTALL_PATH}/csmart/bin/export-recipe.sh \"$recipename\" $1 $2 $3 $4" >> export-all-recipes-from-$3.sh
done

echo "echo \"Done exporting all recipes from DB $3\"" >> export-all-recipes-from-$3.sh

# Now must sed that file to change \ to / in the CIP!
# Note that all backslashed in this file must be double quoted
sed s/\\\\/\\\//g ./export-all-recipes-from-$3.sh > ./exp-fix.sh
mv ./exp-fix.sh ./export-all-recipes-from-$3.sh

echo "Script to export all recipes from $3 has been written as: export-all-recipes-from-$3.sh"
echo "WARNING: If a recipe name contains a space, this file must be edited."
echo "To run this script, do: ./export-all-recipes-from-$3.sh"
echo ""
echo "Done."
